<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºé¡µé¢VIPæ¨¡æ¿è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .template { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; }
        .vip { border-color: #f59e0b; background-color: #fef3c7; }
        .disabled { opacity: 0.6; background-color: #f3f4f6; }
        .vip-badge { background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .tier-badge { padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 5px; }
        .basic { background: #dbeafe; color: #1e40af; }
        .premium { background: #e9d5ff; color: #7c3aed; }
        .elite { background: #fef3c7; color: #d97706; }
        button { margin: 5px; padding: 8px 16px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .result { margin: 20px 0; padding: 15px; background: #f0f9ff; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ åˆ›å»ºé¡µé¢VIPæ¨¡æ¿è°ƒè¯•</h1>
    
    <div>
        <button onclick="testAsAdmin()">æµ‹è¯•Adminç”¨æˆ·</button>
        <button onclick="testAsUser()">æµ‹è¯•æ™®é€šç”¨æˆ·</button>
        <button onclick="testAsVip()">æµ‹è¯•VIPç”¨æˆ·</button>
        <button onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
    </div>

    <div id="result" class="result"></div>
    <div id="templates"></div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentToken = null;

        function addResult(message, isError = false) {
            const result = document.getElementById('result');
            result.innerHTML += `<div style="color: ${isError ? 'red' : 'green'}">${message}</div>`;
        }

        function clearResult() {
            document.getElementById('result').innerHTML = '';
            document.getElementById('templates').innerHTML = '';
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            addResult('âœ… ç¼“å­˜å·²æ¸…é™¤');
        }

        async function login(username, password) {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ç™»å½•å¤±è´¥: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                currentToken = data.accessToken;
                addResult(`âœ… ${username} ç™»å½•æˆåŠŸ`);
                addResult(`Token: ${currentToken ? currentToken.substring(0, 20) + '...' : 'undefined'}`);
                return true;
            } catch (error) {
                addResult(`âŒ ${username} ç™»å½•å¤±è´¥: ${error.message}`, true);
                return false;
            }
        }

        async function getTemplates() {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };
                if (currentToken) {
                    headers['Authorization'] = `Bearer ${currentToken}`;
                }

                addResult(`ğŸ” è¯·æ±‚æ¨¡æ¿APIï¼ŒToken: ${currentToken ? 'æœ‰' : 'æ— '}`);

                const response = await fetch(`${API_BASE}/templates`, {
                    headers,
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`è·å–æ¨¡æ¿å¤±è´¥: ${response.status} - ${errorText}`);
                }

                const templates = await response.json();
                displayTemplates(templates);
                return templates;
            } catch (error) {
                addResult(`âŒ è·å–æ¨¡æ¿å¤±è´¥: ${error.message}`, true);
                return [];
            }
        }

        function displayTemplates(templates) {
            const container = document.getElementById('templates');
            container.innerHTML = '<h2>ğŸ“‹ æ¨¡æ¿åˆ—è¡¨</h2>';
            
            const vipTemplates = templates.filter(t => t.isVipOnly);
            const freeTemplates = templates.filter(t => !t.isVipOnly);
            
            addResult(`ğŸ“Š æ€»æ¨¡æ¿: ${templates.length}, VIPæ¨¡æ¿: ${vipTemplates.length}, å…è´¹æ¨¡æ¿: ${freeTemplates.length}`);
            
            templates.forEach(template => {
                const div = document.createElement('div');
                div.className = `template ${template.isVipOnly ? 'vip' : ''} ${template.canUse === false ? 'disabled' : ''}`;
                
                let badges = '';
                if (template.isVipOnly) {
                    badges += '<span class="vip-badge">ğŸ‘‘ VIP</span>';
                    if (template.vipTier) {
                        const tierClass = template.vipTier.toLowerCase();
                        badges += `<span class="tier-badge ${tierClass}">${template.vipTier}</span>`;
                    }
                }
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3>${template.title}</h3>
                            <p>${template.description}</p>
                            <small>åˆ†ç±»: ${template.category} | æœ€å¤š${template.maxParticipants}äºº</small>
                        </div>
                        <div>
                            ${badges}
                            <div style="margin-top: 5px;">
                                <strong>å¯ç”¨: ${template.canUse !== false ? 'âœ…' : 'âŒ'}</strong>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        async function testAsAdmin() {
            clearResult();
            addResult('ğŸ” æµ‹è¯•Adminç”¨æˆ·...');
            if (await login('admin', 'admin123')) {
                await getTemplates();
            }
        }

        async function testAsUser() {
            clearResult();
            addResult('ğŸ” æµ‹è¯•æ™®é€šç”¨æˆ·...');
            if (await login('testuser2', 'testuser2123')) {
                await getTemplates();
            }
        }

        async function testAsVip() {
            clearResult();
            addResult('ğŸ” æµ‹è¯•VIPç”¨æˆ·...');
            if (await login('vipbasic', 'password123')) {
                await getTemplates();
            }
        }
    </script>
</body>
</html>
